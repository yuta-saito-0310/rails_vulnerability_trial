FROM mcr.microsoft.com/devcontainers/ruby:1-3.2-bullseye

# Install Rails
RUN su vscode -c "gem install rails webdrivers"
RUN su vscode -c "/usr/local/rvm/bin/rvm fix-permissions"

# Default value to allow debug server to serve content over GitHub Codespace's port forwarding service
# The value is a comma-separated list of allowed domains 
ENV RAILS_DEVELOPMENT_HOSTS=".githubpreview.dev,.preview.app.github.dev,.app.github.dev"
ENV ROOT="/workspaces/rails_vulnerability_trial"

WORKDIR ${ROOT}

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential default-libmysqlclient-dev mariadb-client git tig libvips pkg-config

COPY Gemfile ${ROOT}
COPY Gemfile.lock ${ROOT}

RUN bundle config set --local path .bundle
RUN mkdir -p ${ROOT}/.bundle
RUN chown -R vscode:vscode ${ROOT}/.bundle
RUN su vscode -c "bundle install"